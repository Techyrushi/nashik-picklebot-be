<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PicklePlay Payment</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- SweetAlert2 -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Razorpay -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
      :root {
        --primary: #00bfa5;
        --danger: #ff5252;
        --bg: #f9fafb;
        --card: #ffffffc7;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }

      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #a8edea, #fed6e3);
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      .container {
        width: 90%;
        max-width: 480px;
        background: var(--card);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow);
        animation: fadeIn 0.4s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo {
        width: 80px;
        display: block;
        margin: 0 auto 12px;
      }

      h1 {
        text-align: center;
        color: var(--primary);
        font-size: 1.8rem;
        margin-bottom: 10px;
      }

      .booking-details {
        background: #f7f9fb;
        padding: 18px;
        border-radius: 10px;
        font-size: 15px;
        margin-top: 18px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      .booking-details p {
        margin: 6px 0;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        color: #fff;
        margin-top: 15px;
        cursor: pointer;
        transition: 0.25s;
      }

      .btn:hover {
        opacity: 0.9;
      }

      .btn-primary {
        background: var(--primary);
      }

      .btn-danger {
        background: var(--danger);
      }

      .btn-whatsapp {
        background: #25d366;
      }

      footer {
        margin-top: 25px;
        text-align: center;
        font-size: 13px;
      }

      footer a {
        color: #444;
        text-decoration: none;
        margin: 0 5px;
      }

      /* Receipt */
      .receipt {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        margin-top: 25px;
        box-shadow: var(--shadow);
      }

      .receipt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .receipt h2 {
        color: var(--primary);
        margin-bottom: 8px;
      }

      .qr-section {
        text-align: center;
        margin-top: 15px;
      }

      .qr-section img {
        width: 130px;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <img src="/payment/logo" alt="PicklePlay" class="logo" />
      <h1>PicklePlay Payment</h1>

      <div id="loading"><p>Loading booking details...</p></div>
      <div
        id="booking-details"
        class="booking-details"
        style="display: none"
      ></div>

      <button id="pay-button" class="btn btn-primary" style="display: none">
        Pay Now
      </button>
      <button id="cancel-button" class="btn btn-danger" style="display: none">
        Cancel Booking
      </button>

      <div
        id="error-message"
        style="color: var(--danger); margin-top: 10px"
      ></div>
      <div id="receipt" style="display: none"></div>

      <footer>
        <a href="#" id="privacy-link">Privacy Policy</a> |
        <a href="#" id="terms-link">Terms & Conditions</a>
      </footer>
    </div>

    <script>
      let currentBooking = null;

      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const bookingId = params.get("booking") || params.get("booking_id");

        if (!bookingId) {
          document.getElementById("loading").innerHTML =
            "<p style='color:red;'>No booking ID provided</p>";
          return;
        }

        try {
          const res = await fetch(`/payment/booking/${bookingId}`);
          const booking = await res.json();

          if (!res.ok || booking.error)
            throw new Error(booking.error || "Booking not found");

          currentBooking = booking;

          document.getElementById("booking-details").innerHTML = `
            <p><strong>Booking ID:</strong> ${booking.id}</p>
            <p><strong>Date:</strong> ${booking.date}</p>
            <p><strong>Time:</strong> ${booking.slot}</p>
            <p><strong>Court:</strong> ${booking.court}</p>
            <p><strong>Amount:</strong> â‚¹${booking.amount}</p>
          `;

          document.getElementById("loading").style.display = "none";
          document.getElementById("booking-details").style.display = "block";
          document.getElementById("cancel-button").style.display = "block";

          if (booking.status !== "confirmed") {
            document.getElementById("pay-button").style.display = "block";
          } else {
            Swal.fire(
              "Already Paid!",
              "This booking is already confirmed.",
              "info"
            );
          }

          document
            .getElementById("pay-button")
            .addEventListener("click", () =>
              initiatePayment(booking.id, booking.amount, booking)
            );

          document
            .getElementById("cancel-button")
            .addEventListener("click", () => cancelBooking(booking.id));
        } catch (err) {
          document.getElementById(
            "loading"
          ).innerHTML = `<p style='color:red;'>${err.message}</p>`;
        }
      });

      async function initiatePayment(bookingId, amount, bookingData) {
        const btn = document.getElementById("pay-button");
        btn.textContent = "Processing...";
        btn.disabled = true;

        try {
          const res = await fetch("/payment/create-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ bookingId, amount }),
          });
          const data = await res.json();

          if (!res.ok || data.error)
            throw new Error(data.error || "Failed to create order");

          const options = {
            key: data.key,
            amount: data.amount,
            currency: "INR",
            name: "PicklePlay",
            description: `${bookingData.court} | ${bookingData.date} ${bookingData.slot}`,
            order_id: data.order_id,
            handler: function (response) {
              verifyPayment(bookingId, response, bookingData);
            },
            prefill: {
              name: bookingData.name || "User",
              email: bookingData.email || "",
              contact: bookingData.phone || "",
            },
            theme: { color: "#00bfa5" },
          };

          const rzp = new Razorpay(options);
          rzp.open();

          rzp.on("payment.failed", (err) => {
            Swal.fire("Payment Failed", err.error.description, "error");
            btn.textContent = "Pay Now";
            btn.disabled = false;
          });
        } catch (err) {
          Swal.fire("Error", err.message, "error");
          btn.textContent = "Pay Now";
          btn.disabled = false;
        }
      }

      async function verifyPayment(bookingId, response, bookingData) {
        try {
          const res = await fetch("/payment/verify", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              bookingId,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_order_id: response.razorpay_order_id,
              razorpay_signature: response.razorpay_signature,
            }),
          });
          const data = await res.json();

          if (!res.ok || !data.success)
            throw new Error(data.error || "Verification failed");

          showSuccessReceipt(bookingData, response.razorpay_payment_id);
        } catch (err) {
          Swal.fire("Verification Failed", err.message, "error");
        }
      }

      function showSuccessReceipt(bookingData, paymentId) {
        const bookingId = bookingData.id; // ensure we have bookingId

        // Fetch booking details to get the invoice number from DB
        fetch(`/payment/receipt-data/${bookingId}`)
          .then((res) => res.json())
          .then((data) => {
            const invoiceNumber =
              data.invoiceNumber || `INV-${Date.now().toString().slice(-6)}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(
              bookingId
            )}`;

            document.getElementById("booking-details").innerHTML = `
      <div class="receipt">
        <div class="receipt-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2 style="margin:0;">Payment Successful!</h2>
          <p style="margin:0; font-weight:bold;">Invoice: ${invoiceNumber}</p>
        </div>
        <hr>
        <p><strong>Booking ID:</strong> ${bookingData.id}</p>
        <p><strong>Date:</strong> ${bookingData.date}</p>
        <p><strong>Time:</strong> ${bookingData.slot}</p>
        <p><strong>Court:</strong> ${bookingData.court}</p>
        <p><strong>Amount:</strong> â‚¹${bookingData.amount}</p>
        <p><strong>Payment ID:</strong> ${paymentId}</p>
        <div class="qr-section">
          <p><strong>Check-in QR Code</strong></p>
          <img src="${qrCodeUrl}" alt="QR Code" />
        </div>
        <button onclick="window.print()" class="btn btn-primary" style="margin-top:20px;">Print Receipt</button>
      </div>
    `;

            document.getElementById("pay-button").style.display = "none";
            document.getElementById("cancel-button").style.display = "none";
          })
          .catch((err) => {
            console.error("Failed to fetch invoice number:", err);
            Swal.fire("Error", "Failed to fetch invoice number", "error");
          });
      }

      async function cancelBooking(bookingId) {
        if (!confirm("Are you sure you want to cancel this booking?")) return;

        try {
          const res = await fetch(`/payment/cancel/${bookingId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });

          const data = await res.json();
          if (!res.ok)
            throw new Error(data.error || "Failed to cancel booking");

          document.getElementById("booking-details").innerHTML = `
            <h2 style="color:#ff5252;">Booking Cancelled</h2>
            <p>Your booking has been cancelled successfully.</p>
            ${
              data.refundAmount
                ? `<p><strong>Refund Amount:</strong> â‚¹${data.refundAmount}</p>`
                : ""
            }
          `;

          document.getElementById("cancel-button").outerHTML = `
            <a href="https://wa.me/?text=I%20just%20cancelled%20my%20PicklePlay%20booking."
              class="btn btn-whatsapp" target="_blank">
              Message on WhatsApp
            </a>
          `;

          document.getElementById("pay-button").style.display = "none";
        } catch (err) {
          document.getElementById("error-message").textContent = err.message;
        }
      }

      async function loadContentAndShowModal(url, title) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Failed to load content");
          const html = await response.text();

          Swal.fire({
            title,
            html: `<div style="text-align:left; max-height:300px; overflow-y:auto; font-size:14px;">${html}</div>`,
            confirmButtonText: "Close",
            confirmButtonColor: "#00bfa5",
            width: 600,
          });
        } catch (err) {
          Swal.fire("Error", err.message, "error");
        }
      }

      document.getElementById("privacy-link").addEventListener("click", (e) => {
        e.preventDefault();
        loadContentAndShowModal("/payment/privacy", "Privacy Policy");
      });

      document.getElementById("terms-link").addEventListener("click", (e) => {
        e.preventDefault();
        loadContentAndShowModal(
          "/payment/terms&conditions",
          "Terms & Conditions"
        );
      });
    </script>
  </body>
</html>
